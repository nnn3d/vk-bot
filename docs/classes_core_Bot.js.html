<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: classes/core/Bot.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: classes/core/Bot.js</h1>






    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const StandardEventController = require('../base/StandardEventController');
const VK = require('../../vk');
const Chat = require('../core/Chat');
const Message = require('../core/Message');
const promiseFactory = require('../../helpers/promiseFactory');
let mongoose = require('mongoose');

class Bot extends StandardEventController {

    /**
     *
     * @param {{token}} vk
     * @param {{name: String|Array&lt;String>, admins: Array}} bot
     * @param {{uri}} bd
     * @param {Array&lt;ModuleEventController>} coreModules
     * @param {Array&lt;ModuleEventController>} modules
     */
    constructor({
        bot,
        vk,
        db,
        additionalTokens = [],
        coreModules = [],
        modules = [],
    }) {
        super();
        this.config = {
            bot,
            vk,
            db,
            additionalTokens,
            modules,
            coreModules,
        };
        /**
         *
         * @type {Object&lt;Number, Chat>}
         */
        this.chats = {};
        this.createChats = {};
        this.name = bot.name;
        this.admins = bot.admins || [];
        this.vk = this.createVk(vk, true);
        this.additionalAccounts = [];
        additionalTokens.map(token => {
            let config = token instanceof Object ? token : { token };
            this.additionalAccounts.push(this.createVk(Object.assign({}, vk, config)));
        });
        console.log('accs', this.additionalAccounts.length);
        /**
         *
         * @type {Array&lt;ModuleEventController>}
         */
        this.modules = [];
        /**
         *
         * @type {Array&lt;CoreModuleEventController>}
         */
        this.coreModules = [];
        /**
         * @class {Chat}
         */
        this.Chat = Chat.setBot(this);
        /**
         * @class {Message}
         */
        this.Message = Message.setBot(this);

        this.emitLogs = bot.emitLogs || false;

        process.on('SIGINT', () => {
            this.stop()
                .then(() => process.exit(0))
                .catch(() => process.exit(1))
        });
    }


    createVk(options, addProxy = true) {
        return new VK(options);
    }

    _initDB() {
        mongoose.Promise = global.Promise;
        mongoose.connect(this.config.db.uri + this.config.db.name + this.selfId, { config: { autoIndex: true } });
    }

    _initVk() {
        this.vk.longpoll.setMaxListeners(0);
        let promises = this.additionalAccounts.map(vk => {
            return vk.api.users.get()
                .then((info) => {
                    if (!info[0] || !info[0].id) {
                        this.additionalAccounts.splice(this.additionalAccounts.indexOf(vk), 1);
                        throw new Error(`no self id for additional bot`);
                    }
                    vk.selfId = info[0].id;
                    console.log('additional account', vk.selfId, vk.options.token.slice(0, 8));
                    if (!this.admins.includes(vk.selfId)) this.admins.push(vk.selfId);
                });
        });
        return promiseFactory.allAsync(promises)
            .then(() => this.vk.api.users.get())
            .then((info) => {
                this.selfId = info[0] &amp;&amp; info[0].id;
                console.log('self id', this.selfId);
                if (!this.selfId) throw new Error(`no self id`);
            })
            .then(() => {
                if (!this.admins.includes(this.selfId)) this.admins.push(this.selfId);
                this.vk.longpoll.on('error', e => {
                    console.error(e);
                    setTimeout(() => this.vk.longpoll.restart(), 5e3);
                });
                for (let event of this._allEvents) {
                    this.vk.longpoll.on(event, (...args) => this._onAll(event, ...args))
                }
            })
    }

    _initCoreModules() {
        let promiseEvents = [];
        for (let module of this.config.coreModules) {
            promiseEvents.push(() => this.addCoreModule(module));
        }
        return promiseFactory.allSync(promiseEvents);
    }

    _initModules() {
        let promiseEvents = [];
        for (let module of this.config.modules) {
            promiseEvents.push(() => this.addModule(module));
        }
        return promiseFactory.allSync(promiseEvents);
    }

    /**
     *
     * @param {Number} [dialogsCount]
     * @private
     */
    _initChats(dialogsCount = 20) {
        return promiseFactory.allAsync(this._allEvents.map(
            event =>
                this.on(this.eventNames[event], (...args) => this._onMessage(this.eventNames[event], ...args))
            )
        )
    }

    _finalDB() {
        return mongoose.disconnect();
    }

    _finalVk() {
        return this.vk.longpoll.stop();
    }

    _finalCoreModules() {
        let promiseEvents = [];
        for (let module of this.coreModules) {
            promiseEvents.push(module.stop());
        }
        return promiseFactory.allAsync(promiseEvents);
    }

    _finalModules() {
        let promiseEvents = [];
        for (let module of this.modules) {
            promiseEvents.push(module.stop());
        }
        return promiseFactory.allAsync(promiseEvents);
    }

    _finalChats() {
        let promiseEvents = [];
        for (let id of Object.keys(this.chats)) {
            promiseEvents.push(this.chats[id].final());
        }
        return promiseFactory.allAsync(promiseEvents);
    }

    /**
     *
     * @returns {Array&lt;String>}
     */
    get _allEvents() {
        return ['message', 'chat.action', 'chat.create', 'chat.rename', 'chat.invite',
            'chat.kick', 'chat.photo.update', 'chat.photo.remove', 'chat.pin', 'chat.unpin'];
        // return ['message.flag.replace', 'message.flag.set', 'message.flag.remove', 'message',
        //     'message.read.inbox', 'message.read.outbox', 'message.removed', 'chat.action',
        //     'typing.chat', 'chat.create', 'chat.rename', 'chat.invite', 'chat.kick', 'chat.photo.update',
        //     'chat.photo.remove'];
    }

    /**
     *
     * @returns {{create: string, emit: string, noNameEvent: string, newListenerPre: string, newListenerOn: string,
     *     newListenerAfter: string, newMiddlewarePre: string, newMiddlewareOn: string, removeListenerPre: string,
     *     removeListenerOn: string, removeListenerAfter: string, removeMiddlewarePre: string, removeMiddlewareOn:
     *     string, message.flag.replace: string, message.flag.set: string, message.flag.remove: string, message:
     *     string, message.read.inbox: string, message.read.outbox: string, message.removed: string, chat.action:
     *     string, typing.chat: string, chat.create: string, chat.rename: string, chat.invite: string, chat.kick:
     *     string, chat.photo.update: string, chat.photo.remove: string,
     *     initVk: string, initDB: string, initCoreModules: string, initModules: string, initChats: string, initLongPoll: string,
     *     addCoreModule: string, addModule: string, removeCoreModule: string, removeModule: string, createChat:
     *     string, removeChat: string}}
     */
    get eventNames() {
        let eventNames = super.eventNames;
        eventNames.initVk = 'initVk';
        eventNames.initDB = 'initDB';
        eventNames.initCoreModules = 'initCoreModules';
        eventNames.initModules = 'initModules';
        eventNames.initChats = 'initChats';
        eventNames.initLongPoll = 'initLongPoll';
        eventNames.addCoreModule = 'addCoreModule';
        eventNames.addModule = 'addModule';
        eventNames.removeCoreModule = 'removeCoreModule';
        eventNames.removeModule = 'removeModule';
        eventNames.createChat = 'createChat';
        eventNames.removeChat = 'removeChat';
        this._allEvents.map((name) => eventNames[name] = name);
        return eventNames;
    }

    /**
     *
     * @param {String} event
     * @param {BaseMessage} info
     * @param {...*} args
     * @private
     */
    _onMessage(event, info, ...args) {
        if (!info) return;
        let id = info.peer || info.chat + 2e9;
        if (isNaN(id) || id in this.chats) return;
        if (this.config.bot.dev) {
            let dev = this.config.bot.dev;
            if (Array.isArray(dev.chats) &amp;&amp; !dev.chats.includes(id)) return;
        }
        if (!(this.createChats[id]) &amp;&amp; (this.createChats[id] = true)) {
            this.createChats[id] = [[event, info, ...args]];
            this.createChat(id).then((chat) => {
                if (chat &amp;&amp; this.createChats[id]) {
                    let result = this.pause || Promise.resolve();
                    for (let args of this.createChats[id]) {
                        result = result.then(() => chat.onAll(...args));
                    }
                    this.createChats[id] = [];
                } else {
                    if (id in this.createChats) this.createChats[id] = true;
                }
            }).catch(console.error);
        } else if (Array.isArray(this.createChats[id])) {
            this.createChats[id].push([event, info, ...args]);
        }
    }

    _onAll(event, ...args) {
        if (!this.pause)
            return this.emit(event, ...args);
        else return this.pause = this.pause.then(() => this.emit(event, ...args));
    }

    _checkLongpoll() {
        let text = 'test' + Math.random() * 1e5;
        let self = this;
        let timeout;
        let check = message => {
            if (message.peer === this.selfId &amp;&amp; message.user === this.selfId &amp;&amp; message.text === text) {
                self.vk.longpoll.removeListener('message', check);
                clearTimeout(timeout);
            }
        };
        timeout = setTimeout(() => {
            this.vk.longpoll.removeListener('message', check);
            this.vk.longpoll.stop().then(() => this.vk.longpoll.start());
            console.log('longpoll restarted');
        }, 1e4);
        this.vk.longpoll.on('message', check);
        return new Message(this, { peer: this.selfId }).setTitle(text).send().catch(console.error);
    }

    addCoreModule(module) {
        if (this.coreModules.includes(module)) return Promise.resolve(null);
        return this.ctrlEmit((module) => {
            return module.init(this).then(result => {
                if (result !== null) {
                    this.coreModules.push(module);
                    return true;
                } else return null;
            });
        }, this.eventNames.addCoreModule, module);
    }

    addModule(module) {
        if (this.modules.includes(module)) return Promise.resolve(null);
        return this.ctrlEmit((module) => {
            return module.init(this).then(result => {
                if (result !== null) {
                    this.modules.push(module);
                    return true;
                } else return null;
            });
        }, this.eventNames.addModule, module);
    }

    removeCoreModule(module) {
        if (!this.coreModules.includes(module)) return Promise.resolve(false);
        return this.ctrlEmit((module) => {
            let i = this.coreModules.indexOf(module);
            return promiseFactory.funToPromise(() => this.coreModules[i].final())
                .then(() => delete this.coreModules[i])
        }, this.eventNames.removeCoreModule, module);
    }

    removeModule(module) {
        if (!this.modules.includes(module)) return Promise.resolve(false);
        return this.ctrlEmit((module) => {
            let i = this.modules.indexOf(module);
            return promiseFactory.funToPromise(this.modules[i].final)
                .then(() => delete this.modules[i])
        }, this.eventNames.removeModule, module);
    }

    /**
     *
     * @param {Number} id
     * @returns {Promise.&lt;Chat>}
     */
    createChat(id) {
        let chat = new Chat(this, id);
        return this.ctrlEmit((chat) => {
            if (id in this.chats) return this.chats[id];
            return chat.init().then(result => {
                if (result !== null)
                    this.chats[chat.id] = chat;
                return this.chats[chat.id];
            });
        }, this.eventNames.createChat, chat);
    }

    /**
     *
     * @param {Number} id
     * @returns {Promise.&lt;Chat>}
     */
    removeChat(id) {
        let chat = this.chats[id];
        if (!chat) return Promise.resolve(null);
        return this.ctrlEmit(chat => {
            if (!chat) return null;
            console.log('remove chat', chat.id);
            delete this.chats[chat.id];
            delete this.createChats[chat.id];
            return chat.final().then(() => chat);
        }, this.eventNames.removeChat, chat)
    }

    /**
     *
     * @param {String} name
     * @returns {boolean}
     */
    isBotName(name) {
        if (!name) return false;
        if (Array.isArray(this.name)) {
            for (let n of this.name) {
                if (new RegExp(`^[^\w\dа-яё]?${n}[^\w\dа-яё]?$`, 'ig').test(name)) {
                    return true;
                }
            }
        } else {
            return new RegExp(`^[^\w\dа-яё]?${this.name}[^\w\dа-яё]?$`, 'ig').test(name);
        }
    }

    /**
     *
     * @returns {String}
     */
    getBotName() {
        if (Array.isArray(this.name)) {
            return this.name[0];
        } else {
            return this.name;
        }
    }

    /**
     *
     * @returns {Promise.&lt;*>}
     */
    start() {
        this.setPause(false);
        this.ctrlEmit(() => this._initVk(), this.eventNames.initVk)
            .then(() => (
                this.ctrlEmit(() => this._initDB(), this.eventNames.initDB)
            ))
            .then(() => (
                this.ctrlEmit(() => this._initCoreModules(), this.eventNames.initCoreModules)
            ))
            .then(() => (
                this.ctrlEmit(() => this._initModules(), this.eventNames.initModules)
            ))
            .then(() => (
                this.ctrlEmit(() => this._initChats(), this.eventNames.initChats)
            ))
            .catch((err) => (
                console.log(err)
            ))
            .then(() => this.ctrlEmit(() => {
                    let promises = [] || this.additionalAccounts.map(vk => vk.longpoll.start());
                    promises.push(
                        this.vk.longpoll.start()
                            .catch((err) => (
                                this.vk.longpoll.restart()
                            ))
                            .catch((err) => (
                                console.log(err)
                            ))
                    );
                    return promiseFactory.allAsync(promises);
                }, this.eventNames.initLongPoll)
            )
            .then(() => {
                console.log('start bot');
                process.send('ready');
            })
    }

    setPause(set = true) {
        if (set) {
            let time = Date.now();
            if (!this.pause)
                console.log('start pause');
                this.pause = new Promise((resolve, reject) => {
                    this.pauseResolve = resolve;
                    this.pauseReject = reject;
                }).then(() => Date.now() - time);
            return this.pause;
        } else {
            let pause = this.pause;
            this.pause = false;
            if (this.pauseResolve instanceof Function) {
                this.pauseResolve();
                this.pauseResolve = undefined;
                this.pauseReject = undefined;
            } else pause = Promise.resolve();
            return pause.then(() => console.log('stop pause'));
        }
    }

    /**
     *
     * @returns {Promise.&lt;void>}
     */
    stop() {
        this.setPause();
        return Promise.resolve()
            // .then(() => this._finalChats())
            // .then(() => console.log('final chats'))
            .then(() => this._finalModules())
            .then(() => console.log('final modules'))
            .then(() => this._finalCoreModules())
            .then(() => console.log('final core modules'))
            .then(() => this._finalVk())
            .then(() => console.log('final vk'))
            .then(() => this._finalDB())
            // .then(() => this.pauseReject &amp;&amp; this.pauseReject())
            .then(() => console.log('bot stopped'))
    }
}

module.exports = Bot;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BaseEventController.html">BaseEventController</a></li><li><a href="Bot.html">Bot</a></li><li><a href="Chat.html">Chat</a></li><li><a href="EventInfo.html">EventInfo</a></li><li><a href="Message.html">Message</a></li><li><a href="module.exports_module.exports.html">exports</a></li><li><a href="ModuleEventController.html">ModuleEventController</a></li><li><a href="StandardEventController.html">StandardEventController</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Mar 04 2018 01:40:39 GMT+0300 (RTZ 2 (зима))
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
